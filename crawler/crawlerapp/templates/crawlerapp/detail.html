{% extends '../base.html' %} {% block title %}Job {{ job_name }}{% endblock %}{% block content %}
<div class="container">
  <center>

    <div class="row">
      <div class="col s6">
        <h4>Job data for job {{ job_name }}</h4>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Value</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>Job Name</td>
              <td>{{ job_name }}</td>
            </tr>
            <tr>
              <td>Job ID</td>
              <td>{{ job_id }}</td>
            </tr>
            <tr>
              <td>Number of videos crawled</td>
              <td id="num_vids">{{ job_num_vids }}</td>
            </tr>
            <tr>
              <td>Number of videos downloaded</td>
              <td id="downloaded">{{ num_downloaded }}</td>
            </tr>
            <tr>
              <td>Number of filtered (passed) videos</td>
              <td id="job_num_filtered_videos">{{ job_num_filtered_videos }}</td>
            </tr>
            <tr>
              <td>Applied Filters (Logical OR'd)</td>
              <td id="applied_filters">{{ job_applied_filters }}</td>
            </tr>
            <tr>
              <td>Query</td>
              <td>{{ job_query }}</td>
            </tr>
            <tr>
              <td>Time of job creation</td>
              <td>{{ job_created_date }}</td>
            </tr>
            <tr>
              <td>Finished Crawl</td>
              <td id="executed">{{ executed }}</td>
            </tr>
            <tr>
              <td>Finished downloading</td>
              <td id="download_finished">{{ download_finished }}</td>
            </tr>
            <tr>
              <td>Active Filters</td>
              <td id="active_filters">{{ active_filters }}</td>
            </tr>
            <tr>
              <td>Number of videos with frames extracted</td>
              <td id="num_frames_extracted">{{ num_frames_extracted }}</td>
            </tr>
            <tr>
              <td>Number of videos with faces detected</td>
              <td id="num_face_detected">{{ num_face_detected }}</td>
            </tr>
            <tr>
              <td>Number of videos that passed scene change filter</td>
              <td id="num_scene_change_passed">{{ num_scene_change_passed }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col s6">
        <h4>Actions</h4>
        <form id='form-id' method="post">
          {% csrf_token %}
          <!--
           {% if executed == False or download_started == True %}
          <button class="btn-large disabled">Download</button> {% else %}
          <button class="btn-large waves-effect waves-light" type="submit" value="download" name="download">Download</button> {% endif %}-->
          <center>
            {% for filter, index, enabled, progress in filters %}
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">{{ filter.name }}</span>
                    <p>{{ filter.description }}</p>
                  </div>
                  <div class="card-action">
                    {% if download_finished == True and enabled == True %}
                    <button id="{{ filter.name }}" class="btn waves-effect waves-light" type="submit" value="{{ index }}" name="filter">Run Filter</button> {% else %}
                    <button id="{{ filter.name }}" class="btn waves-effect waves-light disabled" type="submit" value="{{ index }}" name="filter">Run Filter</button> {% endif %}
                    <button class="btn waves-effect waves-light" type="submit" value="{{ index }}" name="remove">Clear this Filter</button>
                    {% if progress >= 0 %}
                    <div class="progress">
                      <div id="{{ filter.name }}_progress" class="determinate" style="width: {{ progress }}%"></div>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">Sampled Video</span>
                    <p>Redirects to one of the videos in the filtered videos category</p>
                  </div>
                  <div class="card-action">
                    {% if sampled_url|stringformat:"s" == "None" %}
                    <a href="{% url 'detail' job_id %}">No videos found</a> {% else %}
                    <a href="{{ sampled_url }}" target="_blank">Sampled Video</a> {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </center>

        </form>
      </div>
    </div>
  </center>
</div>
<script>
  window.onload = function() {
    updateProgress("{% url 'update-progress' 12345 %}".replace(/12345/, "{{ job_id }}"))
  };

  function updateProgress(progressUrl) {
    //console.log("Go!");
    fetch(progressUrl).then(function(response) {
      response.json().then(function(data) {
        // update the appropriate UI components
        for (var key in data) {
          //console.log("Getting " + key);
          if (key == "job") {
            for (var k in data.job) {
              try {
                document.getElementById(k).innerHTML = data.job[k];
              } catch (error) {
                //console.log("Error " + error);
              }
            }
          } else if (key == "filters") {
            for (var k in data.filters) {
              var filter = data.filters[k]
              try {
                if (filter[1]) {
                  document.getElementById(filter[0]).className = "btn waves-effect waves-light";
                } else if (!(filter[1])) {
                  document.getElementById(filter[0]).className = "btn waves-effect waves-light disabled";

                  var progress_elem = document.getElementById(filter[0] + "_progress");
                  if (progress_elem) {
                    if (filter[2] < 0) {
                      progress_elem.parentNode.removeChild(progress_elem);
                    } else {
                      progress_elem.style = "width: " + filter[2] + "%";
                    }
                  }
                }
              } catch (error) {
                //console.log("Error " + error);
              }
            }
          } else {
            try {
              document.getElementById(key).innerHTML = data[key];
            } catch (error) {
              //console.log("Error " + error);
            }
          }
        }
        setTimeout(updateProgress, 500, progressUrl);
      });
    });
  }
</script>
{% endblock %}
