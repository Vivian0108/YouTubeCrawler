{% extends '../base.html' %} {% block title %}Job {{ job_name }}{% endblock %}{% block content %}
<div class="container">
  <center>

    <div class="row">
      <div class="col s6">
        <h4>Job data for job {{ job_name }}</h4>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Value</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>Job Name</td>
              <td>{{ job_name }}</td>
            </tr>
            <tr>
              <td>Job ID</td>
              <td>{{ job_id }}</td>
            </tr>
            <tr>
              <td>Number of videos crawled</td>
              <td id="job_num_vids">{{ job_num_vids }}</td>
            </tr>
            <tr>
              <td>Number of videos downloaded</td>
              <td id="num_downloaded">{{ num_downloaded }}</td>
            </tr>
            <tr>
              <td>Number of filtered (passed) videos</td>
              <td id="job_num_filtered_videos">{{ job_num_filtered_videos }}</td>
            </tr>
            <tr>
              <td>Applied Filters (Logical OR'd)</td>
              <td id="job_applied_filters">{{ job_applied_filters }}</td>
            </tr>
            <tr>
              <td>Query</td>
              <td>{{ job_query }}</td>
            </tr>
            <tr>
              <td>Time of job creation</td>
              <td>{{ job_created_date }}</td>
            </tr>
            <tr>
              <td>Finished Crawl</td>
              <td id="executed">{{ executed }}</td>
            </tr>
            <tr>
              <td>Finished downloading</td>
              <td id="download_finished">{{ download_finished }}</td>
            </tr>
            <tr>
              <td>Active Filters</td>
              <td id="active_filters">{{ active_filters }}</td>
            </tr>
            {% for filter_name,filter_dict in filters.items %}
            <tr>
              <td>Number of videos that passed {{ filter_name }}</td>
              <td id="{{ filter_name }}_passed">{{ filter_dict.num_passed }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="col s6">
        <h4>Actions</h4>
        <form id='form-id' method="post">
          {% csrf_token %}
          <!--
           {% if executed == False or download_started == True %}
          <button class="btn-large disabled">Download</button> {% else %}
          <button class="btn-large waves-effect waves-light" type="submit" value="download" name="download">Download</button> {% endif %}-->
          <center>
            {% for filter_name,filter_dict in filters.items %}
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">{{ filter_name }}</span>
                    <p>{{ filter_dict.filter_obj.description }}</p>
                  </div>
                  <div class="card-action">
                    {% if filter_dict.enabled == True %}
                    <button id="{{ filter_name }}" class="btn waves-effect waves-light" type="submit" value="{{ filter_name }}" name="filter">Run Filter</button> {% else %}
                    <button id="{{ filter_name }}" class="btn waves-effect waves-light disabled" type="submit" value="{{ filter_name }}" name="filter">Run Filter</button> {% endif %}
                    <button class="btn waves-effect waves-light" type="submit" value="{{ filter_name }}" name="remove">Clear this Filter</button>


                    <div class="progress" id="{{ filter_name }}_div" style="display: none;">
                      <div id="{{ filter_name }}_progress" class="determinate" style="display: none;"></div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">Sampled Video</span>
                    <p>Redirects to one of the videos in the filtered videos category</p>
                  </div>
                  <div class="card-action">
                    {% if sampled_url|stringformat:"s" == "None" %}
                    <a href="{% url 'detail' job_id %}">No videos found</a> {% else %}
                    <a href="{{ sampled_url }}" target="_blank">Sampled Video</a> {% endif %}
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">Check Celery Status</span>
                    <p>Checks if celery is up and running properly, may take a while.</p>
                  </div>
                  <div class="card-action">
                    <button id="check_celery" class="btn waves-effect waves-light" onclick="celeryStatus({% url 'celery-info' %})">Check Celery</button>
                    <p id="celery_info">Click above to see celery status.</p>
                  </div>
                </div>
              </div>
            </div>
          </center>

        </form>
      </div>
    </div>
  </center>
</div>
<script>
  window.onload = function() {
    updateProgress("{% url 'update-progress' 12345 %}".replace(/12345/, "{{ job_id }}"))
  };

  function updateProgress(progressUrl) {
    //console.log("Go!");
    fetch(progressUrl).then(function(response) {
      response.json().then(function(data) {
        // update the appropriate UI components
        for (var key in data) {
          //console.log("Getting " + key);
          if (key == "filters") {
            for (var k in data[key]) {
              if (data[key][k]["enabled"]) {
                document.getElementById(k).className = "btn waves-effect waves-light";
              } else if (!data[key][k]["enabled"]) {
                document.getElementById(k).className = "btn waves-effect waves-light disabled";
              }
              document.getElementById(k + "_passed").innerHTML = data[key][k]["num_passed"];
              var progress = data[key][k]["progress"];
              if (progress >= 0) {
                document.getElementById(k + "_progress").style = "width: " + progress + "%;";
                document.getElementById(k + "_div").style = "";
              } else {
                document.getElementById(k + "_div").style = "display: none;"
              }

            }
          } else {
            try {
              document.getElementById(key).innerHTML = data[key]
            } catch (err) {
              console.log("Couldn't do: " + key + ": " + err)
            }
          }
        }
        setTimeout(updateProgress, 500, progressUrl);
      });
    });
  }

  function celeryStatus(celery_url) {
    document.getElementById("check_celery").className = "btn waves-effect waves-light disabled";
    document.getElementById("celery_info").innerHTML = "Getting info...";
    fetch(celery_url).then(function(response) {
      response.json().then(function(data) {
        document.getElementById("celery_info").innerHTML = data;
      });
    });
    document.getElementById("check_celery").className = "btn waves-effect waves-light";
  }
</script>
{% endblock %}
