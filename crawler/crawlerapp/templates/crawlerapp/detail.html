{% extends '../base.html' %} {% block title %}Job {{ job_name }}{% endblock %}{% block content %}
<div class="container">
  <center>

    <div class="row">
      <div class="col s6">
        <h4>Job data for job {{ job_name }}</h4>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Value</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>Job Name</td>
              <td>{{ job_name }}</td>
            </tr>
            <tr>
              <td>Job ID</td>
              <td>{{ job_id }}</td>
            </tr>
            <tr>
              <td>Number of videos crawled</td>
              <td id="job_num_vids">{{ job_num_vids }}</td>
            </tr>
            <tr>
              <td>Number of videos downloaded</td>
              <td id="num_downloaded">{{ num_downloaded }}</td>
            </tr>
            <tr>
              <td>Applied Filters (Logical OR'd)</td>
              <td id="job_applied_filters">{{ job_applied_filters }}</td>
            </tr>
            <tr>
              <td>Query</td>
              <td>{{ job_query }}</td>
            </tr>
            <tr>
              <td>Job Language</td>
              <td>{{ job_language }}</td>
            </tr>
            <tr>
              <td>Job Region</td>
              <td>{{ job_region }}</td>
            </tr>
            <tr>
              <td>Time of job creation</td>
              <td>{{ job_created_date }}</td>
            </tr>
            <tr>
              <td>Finished Crawl</td>
              <td id="executed">{{ executed }}</td>
            </tr>
            <tr>
              <td>Finished downloading</td>
              <td id="download_finished">{{ download_finished }}</td>
            </tr>
            <tr>
              <td>Failed Status (If this has text, the crawl has failed and you need to restart the crawl)</td>
              <td id="job_work_status">{{ job_work_status }}</td>
            </tr>
            <tr>
              <td>Active Filters</td>
              <td id="active_filters">{{ active_filters }}</td>
            </tr>
            {% for filter_name,filter_dict in filters.items %}
            <tr>
              <td>Number of videos that passed {{ filter_name }}</td>
              <td id="{{ filter_name }}_passed">{{ filter_dict.num_passed }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="col s6">
        <h4>Actions</h4>
        <form id='form-id' method="post">
          {% csrf_token %}
          <!--
           {% if executed == False or download_started == True %}
          <button class="btn-large disabled">Download</button> {% else %}
          <button class="btn-large waves-effect waves-light" type="submit" value="download" name="download">Download</button> {% endif %}-->
          <center>
            {% for filter_name,filter_dict in filters.items %}
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">{{ filter_name }}</span>
                    <p>{{ filter_dict.filter_obj.description }}</p>
                  </div>
                  <div class="card-action">
                    {% if filter_dict.enabled == True %}
                    <button id="{{ filter_name }}" class="btn waves-effect waves-light" type="submit" value="{{ filter_name }}" name="filter">Run Filter</button> {% else %}
                    <button id="{{ filter_name }}" class="btn waves-effect waves-light disabled" type="submit" value="{{ filter_name }}" name="filter">Run Filter</button> {% endif %}
                    <button class="btn waves-effect waves-light" type="submit" value="{{ filter_name }}" name="remove">Clear this Filter</button>


                    <div class="progress" id="{{ filter_name }}_div" style="display: none;">
                      <div id="{{ filter_name }}_progress" class="determinate" style="display: none;"></div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            <div class="row">
              <div class="col s12">
                <div class="card blue-grey darken-1">
                  <div class="card-content white-text">
                    <span class="card-title">Delete Job</span>
                    <p>Deletes this job and all relevant information.</p>
                  </div>
                  <div class="card-action">
                    <a id="delete_prompt" href="#">Delete Job</a>
                  </div>
                </div>
              </div>
            </div>
          </center>
          <div id="delete_confirm" class="modal">
            <div class="modal-content">

              <h4>Are you sure you want to delete this job?</h4>
              <p>If you delete this job, any videos that this job crawled will be removed from the database, and this job will be removed from any datasets.</p>


            </div>
            <div class="modal-footer">
              <button class="btn waves-effect waves-light" type="submit" value="delete_job" name="delete_job">Delete Job</button>
              <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">Go Back</a>

            </div>
          </div>

        </form>

        <div class="row">
          <div class="col s12">
            <div class="card blue-grey darken-1">
              <div class="card-content white-text">
                <span class="card-title">View Videos</span>
                <p>Redirects to page with all the videos that passed Face Detect filter from this crawl</p>
              </div>
              <div class="card-action">
                <a href="{% url 'view-videos' job_id %}">View Videos</a>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </center>
</div>
<script>
  window.onload = function() {
    updateProgress("{% url 'update-progress' 12345 %}".replace(/12345/, "{{ job_id }}"))
  };

  function updateProgress(progressUrl) {
    //console.log("Go!");
    fetch(progressUrl).then(function(response) {
      response.json().then(function(data) {
        // update the appropriate UI components
        for (var key in data) {
          //console.log("Getting " + key);
          if (key == "filters") {
            for (var k in data[key]) {
              if (data[key][k]["enabled"]) {
                document.getElementById(k).className = "btn waves-effect waves-light";
              } else if (!data[key][k]["enabled"]) {
                document.getElementById(k).className = "btn waves-effect waves-light disabled";
              }
              document.getElementById(k + "_passed").innerHTML = data[key][k]["num_passed"];
              var progress = data[key][k]["progress"];
              if (progress >= 0) {
                document.getElementById(k + "_progress").style = "width: " + progress + "%;";
                document.getElementById(k + "_div").style = "";
              } else {
                document.getElementById(k + "_div").style = "display: none;"
              }

            }
          } else {
            try {
              document.getElementById(key).innerHTML = data[key]
            } catch (err) {
              console.log("Couldn't do: " + key + ": " + err)
            }
          }
        }
        setTimeout(updateProgress, 500, progressUrl);
      });
    });
  }
  $('#delete_prompt').click(function() {
    $('#delete_confirm').modal('open');
  });

  /*
    function celeryStatus(celery_url) {
      document.getElementById("check_celery").className = "btn waves-effect waves-light disabled";
      document.getElementById("celery_info").innerHTML = "Getting info...";
      fetch(celery_url).then(function(response) {
        response.json().then(function(data) {
          document.getElementById("celery_info").innerHTML = data;
        });
      });
      document.getElementById("check_celery").className = "btn waves-effect waves-light";
    }*/
</script>
{% endblock %}
